#### 一致性hash算法

##### 出现原因

* 分布式集群中，通过key 求 hash 取余节点数 决定 访问位置，实现数据分片

* 当节点数变化时（新增节点，节点出错），需要全部重新计算迁移

  

##### 原理

* 一致性hash是对2^32取模， 假设有一个圆环：
  * 对2 ^32取余是有依据的IPV4最大数量就是2^32，所以这样就能保证所有的ip的地址进行取余时不会重复—对应hash环上面的正数。
  * ![Alt text](.\images\hashring.png)
* 服务器位置确定（假定3台服务器ABC)：
  * 用服务器IP地址进行hash计算，使用hash后的结果改过对2^32取模，落在环上
  * ![Alt text](.\images\sring.png)
* 从哪台服务器获取或者保持数据？
  * hash(key)  % 2 ^ 32 落在环上
  * ![Alt text](.\images\kring.png)
  * 沿着顺时针方向遇到的第一个服务器就是A服务器，所以会被缓存到A服务器上



##### 一致性hash算法的优点

*  当服务器节点数量变化的时候只有一部分数据失效



##### hash环偏斜问题

* 集群集中在环的一部分，分布不均匀

##### 虚拟节点

* 将一个实际服务器节点映射在环上的多个虚拟节点

* 虚拟节点”的hash计算可以采用对应节点的IP地址加数字后缀的方式

  * Hash(“192.168.1.100#1”); // NODE1-1

* ```java
  虚拟节点越多，hash环上的节点就越多，缓存均匀分布的概率就越大
  ```

  



###### 使用一致性hash算法框架

* cassandra 集群
* redis集群









##  参考

* https://blog.csdn.net/qq_34672033/article/details/88916789